'use client';

import { useEffect, useMemo, useState } from 'react';
import dynamic from 'next/dynamic';
import Meta from '../../components/SEO/Meta';
import ModuleCard from '../../components/ModuleCard';

type ModuleMetadata = import('../../modules/metadata').ModuleMetadata;

type VirtualListProps<T> = {
  data: T[];
  height: number;
  itemHeight: number;
  itemKey: string | number | ((item: T) => string);
  component?: React.ElementType;
  className?: string;
  children: (item: T) => React.ReactNode;
};

const VirtualizedList = dynamic<VirtualListProps<ModuleMetadata>>(
  () => import('rc-virtual-list'),
  {
    ssr: false,
    loading: () => (
      <div className="rounded border border-dashed border-ub-orange/40 bg-black/30 p-4 text-center text-sm text-ub-orange">
        Preparing module index…
      </div>
    ),
  },
);

let modulesPromise: Promise<ModuleMetadata[]> | null = null;
const loadModules = async () => {
  if (!modulesPromise) {
    modulesPromise = import('../../modules/metadata').then((mod) => {
      if (Array.isArray(mod.default)) return mod.default as ModuleMetadata[];
      if (Array.isArray((mod as { modules?: ModuleMetadata[] }).modules)) {
        return (mod as { modules?: ModuleMetadata[] }).modules ?? [];
      }
      return [];
    });
  }
  return modulesPromise;
};

const PostExploitationClient: React.FC = () => {
  const [modules, setModules] = useState<ModuleMetadata[]>([]);
  const [status, setStatus] = useState<'idle' | 'loading' | 'ready' | 'error'>('idle');
  const [error, setError] = useState<string | null>(null);
  const [query, setQuery] = useState('');
  const [selected, setSelected] = useState<ModuleMetadata | null>(null);
  const [selectedTags, setSelectedTags] = useState<string[]>([]);

  useEffect(() => {
    let cancelled = false;

    const hydrateModules = async () => {
      try {
        setStatus('loading');
        const data = await loadModules();
        if (!cancelled) {
          setModules(data);
          setStatus('ready');
        }
      } catch (err) {
        if (!cancelled) {
          setStatus('error');
          setError(err instanceof Error ? err.message : 'Unable to load modules');
        }
      }
    };

    hydrateModules();

    return () => {
      cancelled = true;
    };
  }, []);

  const allTags = useMemo(() => {
    const tagSet = new Set<string>();
    modules.forEach((m) => m.tags.forEach((tag) => tagSet.add(tag)));
    return Array.from(tagSet).sort();
  }, [modules]);

  const filtered = useMemo(() => {
    const lowered = query.toLowerCase();
    return modules.filter((m) => {
      const matchesQuery = m.name.toLowerCase().includes(lowered);
      const matchesTag =
        selectedTags.length === 0 || m.tags.some((tag) => selectedTags.includes(tag));
      return matchesQuery && matchesTag;
    });
  }, [modules, query, selectedTags]);

  const toggleTag = (tag: string) => {
    setSelectedTags((prev) =>
      prev.includes(tag) ? prev.filter((t) => t !== tag) : [...prev, tag],
    );
  };

  const transcript = `meterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\nmeterpreter > keyscan_start\nStarting the keystroke sniffer...\nmeterpreter > run persistence_service\n[*] Creating service accomplished\n`;

  const copyTranscript = () => {
    navigator.clipboard?.writeText(transcript).catch(() => {});
  };

  if (status === 'idle' || status === 'loading') {
    return (
      <div className="flex min-h-screen flex-col items-center justify-center gap-3 bg-ub-cool-grey p-6 text-white">
        <Meta />
        <p className="animate-pulse text-sm tracking-wide">Loading post-exploitation modules…</p>
      </div>
    );
  }

  if (status === 'error') {
    return (
      <div className="flex min-h-screen items-center justify-center bg-ub-cool-grey p-6 text-white">
        <Meta />
        <pre className="rounded bg-black/40 p-4 text-sm">
          {JSON.stringify({ error }, null, 2)}
        </pre>
      </div>
    );
  }

  return (
    <>
      <Meta />
      <main className="mx-auto grid gap-4 p-4 md:grid-cols-2">
        <section className="prose">
          <h1>Metasploit Post-Exploitation Modules</h1>
          <p>
            Post-exploitation refers to any actions taken after a session is opened. Rapid7&apos;s{' '}
            <a
              href="https://docs.rapid7.com/metasploit/about-post-exploitation/"
              target="_blank"
              rel="noopener noreferrer"
            >
              Metasploit documentation
            </a>{' '}
            explains that these modules run on an active session to help operators gather deeper information,
            escalate privileges, pivot within the network, or maintain persistence.
          </p>
          <input
            type="text"
            placeholder="Search modules..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            className="mb-4 w-full rounded border p-2"
            aria-label="Search modules"
          />
          <div className="mb-4 flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <label key={tag} className="flex items-center space-x-1">
                <input
                  type="checkbox"
                  checked={selectedTags.includes(tag)}
                  onChange={() => toggleTag(tag)}
                  className="rounded"
                  aria-label={`Toggle ${tag}`}
                />
                <span>{tag}</span>
              </label>
            ))}
          </div>
          {filtered.length === 0 ? (
            <p>No modules match your search.</p>
          ) : (
            <VirtualizedList
              data={filtered}
              height={600}
              itemHeight={120}
              itemKey={(item) => item.name}
              component="ul"
              className="grid list-none gap-4 p-0"
            >
              {(module: ModuleMetadata) => (
                <li key={module.name}>
                  <ModuleCard
                    module={module}
                    onSelect={setSelected}
                    selected={selected?.name === module.name}
                    query={query}
                  />
                </li>
              )}
            </VirtualizedList>
          )}
        </section>
        <aside className="prose">
          {selected ? (
            <>
              <h2>{selected.name}</h2>
              <p>{selected.description}</p>
              <h3>Options</h3>
              <ul>
                {selected.options.map((opt) => (
                  <li key={opt.name}>
                    <strong>{opt.name}</strong>{' '}
                    {opt.required ? '(required)' : '(optional)'} - {opt.description}
                  </li>
                ))}
              </ul>
            </>
          ) : (
            <p>Select a module to view details.</p>
          )}
          <h3>Example Transcript</h3>
          <div className="flex items-start gap-2">
            <pre className="flex-1 overflow-x-auto rounded bg-black p-3 font-mono text-green-400">
              {transcript}
            </pre>
            <button
              onClick={copyTranscript}
              className="rounded bg-gray-700 px-2 py-1 text-sm"
            >
              Copy
            </button>
          </div>
        </aside>
      </main>
    </>
  );
};

export default PostExploitationClient;
