import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import PostExploitation from '../pages/post_exploitation';

describe('PostExploitation search experience', () => {
  it('returns fuzzy matches for approximate queries', async () => {
    const user = userEvent.setup();
    render(<PostExploitation />);

    const input = screen.getByPlaceholderText(/search modules/i);
    await user.type(input, 'hash dum');

    expect(await screen.findByTestId('module-card-hashdump')).toBeInTheDocument();
    expect(screen.queryByTestId('module-card-getsystem')).not.toBeInTheDocument();
  });

  it('highlights the regions returned by the fuzzy matcher', async () => {
    const user = userEvent.setup();
    render(<PostExploitation />);

    const input = screen.getByPlaceholderText(/search modules/i);
    await user.type(input, 'hash dum');

    const card = await screen.findByTestId('module-card-hashdump');
    expect(card.querySelectorAll('mark')).not.toHaveLength(0);
  });

  it('supports keyboard navigation and selection via Enter', async () => {
    const user = userEvent.setup();
    render(<PostExploitation />);

    const input = screen.getByPlaceholderText(/search modules/i);
    input.focus();

    await user.keyboard('{ArrowDown}');

    const keyscanCard = await screen.findByTestId('module-card-keyscan_start');
    await waitFor(() => expect(keyscanCard).toHaveClass('bg-gray-100'));

    await user.keyboard('{Enter}');

    expect(
      await screen.findByRole('heading', { level: 2, name: 'keyscan_start' })
    ).toBeInTheDocument();
  });
});
