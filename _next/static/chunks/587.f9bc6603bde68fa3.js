"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[587],{20587:(e,t,r)=>{r.r(t),r.d(t,{default:()=>b});var a=r(37876),l=r(14232),o=r(70994);let n=e=>{let{towers:t}=e,r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let e=r.current;if(!e)return;let a=e.getContext("2d");if(!a)return;let l={};t.forEach(e=>{let t=e.type||"single",r=Math.max(.3,Math.min(1.2,1-(e.level-1)*.08)),a=e.damage/r;l[t]=(l[t]||0)+a});let o=Object.entries(l),n=window.devicePixelRatio||1,i=e.getBoundingClientRect(),s=i.width||e.width,c=i.height||e.height;if((e.width!==Math.round(s*n)||e.height!==Math.round(c*n))&&(e.width=Math.round(s*n),e.height=Math.round(c*n)),a.setTransform(n,0,0,n,0,0),a.clearRect(0,0,s,c),!o.length){a.fillStyle="#9ca3af",a.font="12px sans-serif",a.fillText("No towers placed yet.",12,c/2);return}let d=Math.max(...o.map(e=>{let[,t]=e;return t}),1),u=s/o.length;o.forEach((e,t)=>{let[r,l]=e,o=l/d*(c-28),n=t*u+6;a.fillStyle="#00f5ff",a.fillRect(n,c-o-20,u-12,o),a.fillStyle="#ffffff",a.font="11px sans-serif",a.fillText("".concat(r,": ").concat(l.toFixed(1)," DPS"),n,c-6)})},[t]),(0,a.jsx)("canvas",{ref:r,width:300,height:120,className:"bg-[color:var(--kali-panel)]",role:"img","aria-label":"Tower DPS chart"})},i={single:[{range:1.5,damage:2},{range:2.5,damage:3},{range:3.5,damage:4}]},s={fast:{speed:60,health:5},tank:{speed:30,health:15}},c=e=>{let{tower:t}=e,r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let e=r.current;if(!e)return;let a=e.getContext("2d");if(!a)return;let l=window.devicePixelRatio||1,o=e.getBoundingClientRect(),n=o.width||e.width,s=o.height||e.height;(e.width!==Math.round(n*l)||e.height!==Math.round(s*l))&&(e.width=Math.round(n*l),e.height=Math.round(s*l)),a.setTransform(l,0,0,l,0,0),a.clearRect(0,0,n,s);let c=Array.from(new Set(Object.values(i).flat().map(e=>e.range))).sort((e,t)=>e-t),d=c.length?c:[t.range],u=Math.max(...d,t.range,1);d.forEach((e,r)=>{let l=e<=t.range;a.strokeStyle=l?"#ffff00":"#555555",a.lineWidth=l?2:1;let o=e/u*(n/2-6);a.beginPath(),a.arc(n/2,s/2,o,0,2*Math.PI),a.stroke(),e===t.range&&(a.fillStyle="#24f0ff",a.beginPath(),a.arc(n/2,s/2,3,0,2*Math.PI),a.fill()),a.fillStyle="#ffffff",a.font="9px sans-serif",a.fillText("".concat(r+1),n/2+o+2,s/2-2)})},[t]),(0,a.jsx)("canvas",{ref:r,width:80,height:80,className:"bg-[color:var(--kali-panel)]",role:"img","aria-label":"Range upgrade tree"})},d=e=>8+2*e,u="Paint at least two cells to define a route.",h=e=>e.map(e=>({...e})),p=()=>({enemiesDefeated:0,enemiesLeaked:0,wavesCleared:0,elapsedMs:0}),x=function(){var e,t,r,a,l,o,n,i,c,x;let g=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},f=null!=(e=g.gridSize)?e:10,m=null!=(t=g.cellSize)?t:40,v=null!=(r=g.baseTowerCost)?r:10,b=null!=(a=g.startingGold)?a:30,k=null!=(l=g.startingLives)?l:10,y=null!=(o=g.spawnInterval)?o:1,w=null!=(n=g.waveConfig)?n:[[,,,,,].fill("fast")],S=null!=(i=g.countdownSeconds)?i:2.5,N={gridSize:f,cellSize:m,baseTowerCost:v,editing:null==(c=g.editing)||c,pathCells:h(null!=(x=g.pathCells)?x:[]),route:[],routeError:u,towers:[],gold:b,lives:k,waveNumber:1,countdown:null,runStatus:"idle",spawnInterval:y,waveConfig:w.map(e=>[...e]),enemies:[],damageNumbers:[],hitRings:[],shotLines:[],stats:p()},C=Array.from({length:80},()=>({active:!1,id:0,x:0,y:0,pathIndex:0,progress:0,health:0,resistance:0,baseSpeed:0,slow:null,dot:null,type:"basic"})),j=0,R=0,M=1,z=new Map,E=()=>{N.enemies=[],C.forEach(e=>{e.active=!1}),j=0,R=0},I=()=>{let e=((e,t)=>{if(e.length<2)return u;for(let r=0;r<e.length;r+=1){let a=e[r];if(a.x<0||a.y<0||a.x>=t||a.y>=t)return"Route cells must stay within the grid.";if(0===r)continue;let l=e[r-1];if(1!==Math.abs(l.x-a.x)+Math.abs(l.y-a.y))return"Route must be painted cell-by-cell without diagonals or gaps."}return null})(N.pathCells,f);N.routeError=e,N.route=e?[]:h(N.pathCells)};I();let T=()=>{E(),z.clear(),N.damageNumbers=[],N.hitRings=[],N.shotLines=[],N.gold=b,N.lives=k,N.waveNumber=1,N.countdown=null,N.runStatus="idle",N.stats=p()},P=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return N.routeError||N.route.length<2?{ok:!1,toast:"Finish a valid route before launching waves."}:(E(),N.countdown=e?0:S,N.runStatus=e?"running":"countdown",N.stats=p(),N.stats.elapsedMs=0,{ok:!0})};return{getState:()=>N,getUiState:()=>({...N,pathCells:h(N.pathCells),route:h(N.route),towers:N.towers.map(e=>({...e})),waveConfig:N.waveConfig.map(e=>[...e]),enemies:N.enemies.map(e=>({...e})),damageNumbers:N.damageNumbers.map(e=>({...e})),hitRings:N.hitRings.map(e=>({...e})),shotLines:N.shotLines.map(e=>({...e})),stats:{...N.stats}}),dispatch:e=>{var t,r;switch(e.type){case"add-path-cell":{if(!N.editing)return{ok:!1,toast:"Route editing is disabled."};let t=e.cell;if(t.x<0||t.y<0||t.x>=f||t.y>=f)return{ok:!1,toast:"That cell is outside the grid."};if(N.towers.some(e=>e.x===t.x&&e.y===t.y))return{ok:!1,toast:"Remove the tower before painting this cell."};let r=N.pathCells[N.pathCells.length-1];if(r&&r.x===t.x&&r.y===t.y)return N.pathCells.pop(),I(),{ok:!0};if(N.pathCells.some(e=>e.x===t.x&&e.y===t.y))return{ok:!1,toast:"Route order is locked. Use Undo to remove the last cell."};if(r&&1!==Math.abs(r.x-t.x)+Math.abs(r.y-t.y))return{ok:!1,toast:"New route cells must touch the last cell."};return N.pathCells.push({...t}),I(),{ok:!0}}case"undo-path-cell":if(!N.pathCells.length)return{ok:!1,toast:"No route cells to undo."};return N.pathCells.pop(),I(),{ok:!0};case"clear-path-cells":return N.pathCells=[],I(),{ok:!0};case"set-path-cells":return N.pathCells=h(e.cells),I(),{ok:!0};case"set-editing":return N.editing=e.editing,{ok:!0};case"place-tower":{let t=e.cell;if(N.pathCells.some(e=>e.x===t.x&&e.y===t.y))return{ok:!1,toast:"Towers cannot be placed on the route."};if(N.gold<v)return{ok:!1,toast:"Not enough gold to place a tower."};return N.towers.push({x:t.x,y:t.y,range:1.5,damage:2,level:1}),N.gold-=v,{ok:!0}}case"clear-towers":return N.towers=[],z.clear(),{ok:!0};case"sell-tower":{let t=N.towers[e.index];if(!t)return{ok:!1};let r=v;for(let e=1;e<t.level;e+=1)r+=d(e);return N.gold+=Math.max(1,Math.floor(.6*r)),N.towers=N.towers.filter((t,r)=>r!==e.index),{ok:!0}}case"upgrade-tower":{let r=N.towers[e.index];if(!r)return{ok:!1};let a=d(r.level);if(N.gold<a)return{ok:!1,toast:"Not enough gold for that upgrade."};N.gold-=a;let l={...r};return t=e.upgrade,l.level+=1,"range"===t?l.range+=1:l.damage+=1,N.towers=N.towers.map((t,r)=>r===e.index?l:t),{ok:!0}}case"reset-run":return T(),{ok:!0};case"start-run":return P(e.skipCountdown);case"set-wave-config":return N.waveConfig=e.waves.map(e=>[...e]),{ok:!0};case"set-spawn-interval":return N.spawnInterval=e.value,{ok:!0};case"apply-preset":return N.pathCells=h(e.pathCells),N.waveConfig=e.waveConfig.map(e=>[...e]),N.spawnInterval=e.spawnInterval,N.editing=null!=(r=e.editing)&&r,N.towers=[],b=e.startingGold,k=e.startingLives,N.gold=b,N.lives=k,N.waveNumber=1,N.countdown=null,N.runStatus="idle",N.stats=p(),E(),I(),{ok:!0};default:return{ok:!1}}},tick:e=>{("running"===N.runStatus||"countdown"===N.runStatus)&&(N.stats.elapsedMs+=1e3*e),(e=>{if("defeat"===N.runStatus||"victory"===N.runStatus)return;if("countdown"===N.runStatus){if(null===N.countdown)return;let t=N.countdown-e;N.countdown=t<=0?null:t,t<=0&&(N.runStatus="running",R=0,j=0);return}if("running"!==N.runStatus)return;R+=e;let t=N.waveConfig[N.waveNumber-1]||[];R>=N.spawnInterval&&j<t.length&&(R=0,(()=>{let e=N.route;if(!e.length)return;let t=(N.waveConfig[N.waveNumber-1]||[])[j];if(!t)return;let r=s[t],a=((e,t)=>{let r=e.find(e=>!e.active);return r?(Object.assign(r,t,{active:!0}),r):null})(C,{id:M,x:e[0].x,y:e[0].y,pathIndex:0,progress:0,health:r.health,resistance:0,baseSpeed:r.speed,slow:null,dot:null,type:t});a&&(M+=1,N.enemies.push(a))})(),j+=1),j>=t.length&&0===N.enemies.length&&(N.waveNumber<N.waveConfig.length?(N.stats.wavesCleared+=1,N.waveNumber+=1,N.runStatus="countdown",N.countdown=S,j=0,R=0):(N.stats.wavesCleared=N.waveConfig.length,N.runStatus="victory",N.countdown=null))})(e),"running"===N.runStatus&&((e=>{let t=N.route;if(!t.length)return;let r=[];for(let a of N.enemies){let{pathIndex:l,progress:o}=a,n=a.x,i=a.y;for(;;){let r=l+1;if(!t[r])break;let s=t[l],c=t[r],d=c.x-s.x,u=c.y-s.y,h=Math.hypot(d,u)||1;if((o+=a.baseSpeed*e/m/h)<1){n=s.x+d*o,i=s.y+u*o;break}o-=1,l=r,n=c.x,i=c.y}if(l>=t.length-1){if(a.active=!1,N.lives=Math.max(N.lives-1,0),N.stats.enemiesLeaked+=1,0===N.lives){N.runStatus="defeat",N.countdown=null,N.enemies=[];return}continue}a.x=n,a.y=i,a.pathIndex=l,a.progress=o,r.push(a)}N.enemies=r})(e),"running"===N.runStatus&&(e=>{let t=N.enemies;if(!t.length)return;let r={fast:3,tank:6};N.towers.forEach(r=>{var a;let l,o=(l={x:r.x,y:r.y},"".concat(l.x,",").concat(l.y)),n=Math.max(0,(null!=(a=z.get(o))?a:0)-e);if(z.set(o,n),n>0)return;let i=r.x+.5,s=r.y+.5,c=t.find(e=>Math.hypot(e.x+.5-i,e.y+.5-s)<=r.range);c&&(c.health-=r.damage,z.set(o,Math.max(.3,Math.min(1.2,1-(r.level-1)*.08))),N.shotLines.push({x1:r.x,y1:r.y,x2:c.x,y2:c.y,life:.25}),N.damageNumbers.push({x:c.x,y:c.y,value:r.damage,life:1}),N.hitRings.push({x:c.x,y:c.y,life:1}))});let a=[];t.forEach(e=>{var t,l;if(e.health>0)return void a.push(e);e.active=!1;let o=null!=(l=r[null!=(t=e.type)?t:"fast"])?l:2;N.gold+=o,N.stats.enemiesDefeated+=1}),N.enemies=a})(e)),N.damageNumbers.forEach(t=>{t.y-=.5*e,t.life-=1.5*e}),N.damageNumbers=N.damageNumbers.filter(e=>e.life>0),N.hitRings.forEach(t=>{t.life-=2*e}),N.hitRings=N.hitRings.filter(e=>e.life>0),N.shotLines.forEach(t=>{t.life-=3*e}),N.shotLines=N.shotLines.filter(e=>e.life>0)},resetRun:T,startRun:P}};var g=r(35539);let f=(e,t,r)=>Math.max(t,Math.min(r,e)),m=e=>{if(!e.length)return[];let t=[{...e[0]}];for(let r=1;r<e.length;r+=1){let a=e[r-1],l=e[r],o=Math.sign(l.x-a.x),n=Math.sign(l.y-a.y),i={...a};for(;i.x!==l.x||i.y!==l.y;)i={x:i.x+o,y:i.y+n},t.push({...i})}return t},v=[{id:"straight",name:"Straight Shot",summary:"Short lane with fast scouting waves.",pathCells:m([{x:0,y:4},{x:9,y:4}]),waveConfig:[["fast","fast","fast","tank"],["fast","tank","fast","fast","tank"],["tank","tank","fast","fast","fast","tank"]],spawnInterval:.8,startingGold:35,startingLives:12},{id:"corner",name:"Corner Crawl",summary:"Longer path that favors patient builds.",pathCells:m([{x:0,y:1},{x:9,y:1},{x:9,y:8}]),waveConfig:[["fast","fast","tank"],["tank","fast","tank","fast","fast"],["tank","tank","tank"]],spawnInterval:1.1,startingGold:40,startingLives:14},{id:"zigzag",name:"Zigzag Drift",summary:"Bends and turns with mixed pressure.",pathCells:m([{x:0,y:2},{x:6,y:2},{x:6,y:6},{x:2,y:6},{x:2,y:9},{x:9,y:9}]),waveConfig:[["fast","fast","fast","fast"],["tank","fast","tank","fast"],["fast","tank","tank","fast","fast"]],spawnInterval:.9,startingGold:38,startingLives:13}],b=function(){var e,t,r;let i,u,h,p,m,{windowMeta:b}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=null==(r=null==b?void 0:b.isFocused)||r,y=(0,l.useRef)(null),w=(0,l.useRef)((i=null,u=null,h="",p=1,m=0,{render:(e,t,r)=>{var a,l,o,n,c,d,x,g,f,v,b,k,y,w;let S=window.devicePixelRatio||1,N=t.gridSize*t.cellSize,C=N*S;(e.canvas.width!==C||e.canvas.height!==C)&&(e.canvas.width=C,e.canvas.height=C);let j=t.pathCells.map(e=>"".concat(e.x,",").concat(e.y)).join("|");(j!==h||S!==p||N!==m)&&(h=j,p=S,m=N,((e,t)=>{let r=e.gridSize*e.cellSize,a=r*t;i||(i=document.createElement("canvas")),(i.width!==a||i.height!==a)&&(i.width=a,i.height=a),(u=i.getContext("2d"))&&(u.setTransform(t,0,0,t,0,0),u.clearRect(0,0,r,r),((e,t,r)=>{e.strokeStyle="#555";for(let a=0;a<=t;a+=1)e.beginPath(),e.moveTo(a*r,0),e.lineTo(a*r,t*r),e.stroke(),e.beginPath(),e.moveTo(0,a*r),e.lineTo(t*r,a*r),e.stroke()})(u,e.gridSize,e.cellSize),((e,t,r,a)=>{e.fillStyle="rgba(255,255,0,0.18)",t.forEach(t=>{e.fillRect(t.x*a,t.y*a,a,a)}),r.length&&(e.strokeStyle="rgba(0,255,255,0.9)",e.lineWidth=2,e.beginPath(),r.forEach((t,r)=>{let l=t.x*a+a/2,o=t.y*a+a/2;0===r?e.moveTo(l,o):e.lineTo(l,o)}),e.stroke(),e.lineWidth=1);let l=t[0],o=t[t.length-1];l&&(e.fillStyle="rgba(0,255,0,0.6)",e.fillRect(l.x*a+6,l.y*a+6,a-12,a-12)),o&&(e.fillStyle="rgba(255,0,0,0.6)",e.fillRect(o.x*a+6,o.y*a+6,a-12,a-12))})(u,e.pathCells,e.route,e.cellSize))})(t,S)),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,e.canvas.width,e.canvas.height),i&&e.drawImage(i,0,0),e.setTransform(S,0,0,S,0,0),a=e,l=t,o=r,l.towers.forEach((e,t)=>{a.fillStyle="#24f0ff",a.fillRect(e.x*l.cellSize+8,e.y*l.cellSize+8,l.cellSize-16,l.cellSize-16),(o.selectedIndex===t||o.hoveredIndex===t)&&(a.strokeStyle="rgba(255,255,0,0.9)",a.beginPath(),a.arc(e.x*l.cellSize+l.cellSize/2,e.y*l.cellSize+l.cellSize/2,e.range*l.cellSize,0,2*Math.PI),a.stroke())}),n=e,(c=t).enemies.forEach(e=>{var t,r;n.fillStyle="#ff4b4b",n.beginPath(),n.arc(e.x*c.cellSize+c.cellSize/2,e.y*c.cellSize+c.cellSize/2,c.cellSize/4,0,2*Math.PI),n.fill();let a=Math.max(0,e.health),l=null!=(r=null==(t=s[e.type])?void 0:t.health)?r:e.health,o=c.cellSize/2*(a/Math.max(1,l));n.fillStyle="#111",n.fillRect(e.x*c.cellSize+c.cellSize/4,e.y*c.cellSize+6,c.cellSize/2,4),n.fillStyle="#4ade80",n.fillRect(e.x*c.cellSize+c.cellSize/4,e.y*c.cellSize+6,o,4)}),d=e,x=t.shotLines,g=t.cellSize,x.forEach(e=>{d.strokeStyle="rgba(36,240,255,".concat(2*e.life,")"),d.beginPath(),d.moveTo(e.x1*g+g/2,e.y1*g+g/2),d.lineTo(e.x2*g+g/2,e.y2*g+g/2),d.stroke()}),f=e,v=t.hitRings,b=t.cellSize,v.forEach(e=>{f.strokeStyle="rgba(255,0,0,".concat(e.life,")"),f.beginPath(),f.arc(e.x*b+b/2,e.y*b+b/2,b/2*(1-.5*e.life),0,2*Math.PI),f.stroke()}),k=e,y=t.damageNumbers,w=t.cellSize,y.forEach(e=>{k.fillStyle="rgba(255,255,255,".concat(e.life,")"),k.font="12px sans-serif",k.fillText(e.value.toString(),e.x*w+w/2,e.y*w+w/2-(1-e.life)*10)}),r.showCursor&&(e.strokeStyle="rgba(255,255,255,0.8)",e.setLineDash([4,4]),e.strokeRect(r.cursor.x*t.cellSize+2,r.cursor.y*t.cellSize+2,t.cellSize-4,t.cellSize-4),e.setLineDash([]))}})),S=(0,l.useRef)(x({})),[N,C]=(0,l.useState)(S.current.getUiState()),[j,R]=(0,l.useState)(null),M=(0,l.useRef)(j),z=(0,l.useRef)(null),E=(0,l.useRef)({x:0,y:0}),I=(0,l.useRef)(!1),[T,P]=(0,l.useState)(!1),[L,D]=(0,l.useState)(!1),A=(0,l.useRef)(!1),[F,W]=(0,l.useState)(null),O=(0,l.useRef)(null),[G,B]=(0,l.useState)(""),[U,J]=(0,l.useState)(0),_=(0,l.useRef)(null),q=(0,l.useRef)(0);(0,l.useEffect)(()=>{M.current=j},[j]),(0,l.useEffect)(()=>{A.current=T||L},[T,L]),(0,l.useEffect)(()=>{B(JSON.stringify(N.waveConfig,null,2))},[N.waveConfig]),(0,l.useEffect)(()=>()=>{O.current&&clearTimeout(O.current)},[]);let X=(0,l.useCallback)(()=>{C(S.current.getUiState())},[]),Y=(0,l.useCallback)(e=>{W(e),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{W(null)},2400)},[]),Q=(0,l.useCallback)(e=>{let t=v[e];if(!t)return;let r=S.current.dispatch({type:"apply-preset",pathCells:t.pathCells,waveConfig:t.waveConfig,spawnInterval:t.spawnInterval,startingGold:t.startingGold,startingLives:t.startingLives,editing:!1});!r.ok&&r.toast&&Y(r.toast),P(!1),R(null),J(e),X()},[Y,X]);(0,l.useEffect)(()=>{Q(0)},[Q]);let K=(e,t)=>{let r=y.current;if(!r)return null;let a=r.getBoundingClientRect(),l=r.width/a.width,o=r.height/a.height,n=Math.floor((e-a.left)*l/N.cellSize),i=Math.floor((t-a.top)*o/N.cellSize);return Number.isNaN(n)||Number.isNaN(i)||n<0||i<0||n>=N.gridSize||i>=N.gridSize?null:{x:n,y:i}},V=e=>{let t=S.current.dispatch({type:"place-tower",cell:e});if(!t.ok){t.toast&&Y(t.toast);return}X(),R(S.current.getState().towers.length-1)},Z=e=>{let t=S.current.dispatch({type:"sell-tower",index:e});!t.ok&&t.toast&&Y(t.toast),R(null),X()},H=()=>{let{route:e,routeError:t}=S.current.getState();if(t||e.length<2)return void Y("Finish a valid route before launching waves.");S.current.dispatch({type:"set-editing",editing:!1}),S.current.dispatch({type:"reset-run"});let r=S.current.dispatch({type:"start-run"});!r.ok&&r.toast&&(Y(r.toast),S.current.dispatch({type:"set-editing",editing:!0})),P(!1),X()},$=e=>{if(null===M.current)return;let t=S.current.dispatch({type:"upgrade-tower",index:M.current,upgrade:e});!t.ok&&t.toast&&Y(t.toast),X()};(0,g.default)(e=>{let t=f(e,0,.05);A.current||S.current.tick(t);let r=y.current,a=null==r?void 0:r.getContext("2d");r&&a&&w.current.render(a,S.current.getState(),{hoveredIndex:z.current,selectedIndex:M.current,cursor:E.current,showCursor:I.current}),q.current+=e,q.current>=.25&&(q.current=0,X())});let ee=(0,l.useMemo)(()=>null!==j?N.towers[j]:null,[j,N.towers]),et=N.editing?"Path Editing":"running"===N.runStatus?"Defense Active":"countdown"===N.runStatus?"Wave Countdown":"Planning",er="victory"===N.runStatus?"All waves cleared":"defeat"===N.runStatus?"Base overrun":null!==N.countdown?"Next wave in ".concat(Math.ceil(N.countdown),"s"):"running"===N.runStatus?"".concat(N.enemies.length," enemies active"):"".concat(N.waveConfig.length," wave").concat(1===N.waveConfig.length?"":"s"," queued"),ea=N.editing?"Click or press Enter/Space to paint route cells in order. Start is first; goal is last.":"Place or select towers to defend the exact painted route. Right-click or Delete to sell.",el=N.route.length>=2&&!N.routeError,eo="victory"===N.runStatus||"defeat"===N.runStatus;return(0,a.jsx)(o.default,{gameId:"tower-defense",onPauseChange:e=>D(e),isFocused:k,children:(0,a.jsxs)("div",{className:"p-3 text-[color:var(--kali-text)]",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start",children:[(0,a.jsxs)("div",{className:"flex flex-1 flex-col items-center gap-3",children:[(0,a.jsxs)("div",{className:"relative w-full max-w-[420px]",children:[(0,a.jsx)("canvas",{ref:y,className:"h-auto w-full rounded-lg border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)] shadow-inner focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary)]","aria-label":"Tower defense map canvas",style:{imageRendering:"pixelated"},onClick:e=>{let t=K(e.clientX,e.clientY);if(!t)return;E.current=t;let r=S.current.getState();if(r.editing){let e=S.current.dispatch({type:"add-path-cell",cell:t});!e.ok&&e.toast&&Y(e.toast),X();return}let a=r.towers.findIndex(e=>e.x===t.x&&e.y===t.y);if(a>=0)return void R(a);V(t)},onContextMenu:e=>{e.preventDefault();let t=K(e.clientX,e.clientY);if(!t)return;let r=S.current.getState().towers.findIndex(e=>e.x===t.x&&e.y===t.y);r<0||Z(r)},onMouseMove:e=>{let t=K(e.clientX,e.clientY);if(!t){z.current=null;return}let r=S.current.getState().towers.findIndex(e=>e.x===t.x&&e.y===t.y);z.current=r>=0?r:null},onMouseLeave:()=>{z.current=null},onKeyDown:e=>{if(e.key.startsWith("Arrow")){e.preventDefault();let t=E.current,r={...t};"ArrowUp"===e.key&&(r.y=f(t.y-1,0,N.gridSize-1)),"ArrowDown"===e.key&&(r.y=f(t.y+1,0,N.gridSize-1)),"ArrowLeft"===e.key&&(r.x=f(t.x-1,0,N.gridSize-1)),"ArrowRight"===e.key&&(r.x=f(t.x+1,0,N.gridSize-1)),E.current=r;return}if("Enter"===e.key||" "===e.key){e.preventDefault();let t=E.current;if(N.editing){let e=S.current.dispatch({type:"add-path-cell",cell:t});!e.ok&&e.toast&&Y(e.toast),X()}else{let e=S.current.getState().towers.findIndex(e=>e.x===t.x&&e.y===t.y);e>=0?R(e):V(t)}return}if("Delete"===e.key||"Backspace"===e.key){if(e.preventDefault(),N.editing){let e=S.current.dispatch({type:"undo-path-cell"});!e.ok&&e.toast&&Y(e.toast),X()}else null!==M.current&&Z(M.current);return}if("Escape"===e.key){e.preventDefault(),R(null);return}"p"===e.key.toLowerCase()&&(e.preventDefault(),P(e=>!e))},onFocus:()=>{I.current=!0},onBlur:()=>{I.current=!1},tabIndex:0}),(0,a.jsxs)("div",{className:"pointer-events-none absolute inset-0 flex flex-col justify-between p-2 text-[0.7rem] sm:text-xs",children:[(0,a.jsxs)("div",{className:"flex justify-between gap-2",children:[(0,a.jsxs)("div",{className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 px-2 py-1 font-medium uppercase tracking-wide text-[color:var(--kali-text)] shadow-kali-panel backdrop-blur","data-testid":"tower-defense-wave",children:[(0,a.jsxs)("p",{className:"text-[0.65rem] text-[color:var(--kali-text)] opacity-80 sm:text-xs",children:["Wave ",N.waveNumber]}),(0,a.jsx)("p",{className:"font-normal normal-case text-[color:var(--kali-text)] opacity-90",children:er})]}),(0,a.jsxs)("div",{className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 px-2 py-1 text-right font-medium uppercase tracking-wide text-[color:var(--kali-text)] shadow-kali-panel backdrop-blur",children:[(0,a.jsx)("p",{className:"text-[0.65rem] text-[color:var(--kali-text)] opacity-80 sm:text-xs",children:"Status"}),(0,a.jsx)("p",{className:"font-normal normal-case text-[color:var(--kali-text)] opacity-90",children:et})]})]}),(0,a.jsxs)("div",{className:"flex items-end justify-between gap-2",children:[(0,a.jsxs)("div",{className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 px-2 py-1 text-[color:var(--kali-text)] shadow-kali-panel backdrop-blur",children:[(0,a.jsx)("p",{className:"text-[0.65rem] font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-80",children:"Lives / Gold"}),(0,a.jsxs)("p",{className:"text-[0.65rem] text-[color:var(--kali-text)] opacity-90 sm:text-xs",children:[N.lives," lives \xb7 ",N.gold," gold"]})]}),ee&&(0,a.jsxs)("div",{className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 px-2 py-1 text-[color:var(--kali-text)] shadow-kali-panel backdrop-blur",children:[(0,a.jsx)("p",{className:"text-[0.65rem] font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-80",children:"Tower"}),(0,a.jsxs)("p",{className:"text-[0.65rem] text-[color:var(--kali-text)] opacity-90 sm:text-xs",children:["Range ",ee.range.toFixed(1)," \xb7 Damage ",ee.damage.toFixed(1)," \xb7 Lv ",ee.level]})]})]})]}),F&&(0,a.jsx)("div",{className:"absolute left-1/2 top-3 -translate-x-1/2 rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-wide text-[color:var(--kali-text)] shadow-kali-panel",role:"status","aria-live":"polite",children:F}),eo&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-black/70 p-4 text-center text-[color:var(--kali-text)]",children:(0,a.jsxs)("div",{className:"w-full max-w-sm space-y-3 rounded-lg border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/95 p-4 shadow-kali-panel",children:[(0,a.jsx)("h3",{className:"text-sm font-semibold uppercase tracking-wide text-[color:var(--kali-text)]",children:"victory"===N.runStatus?"Victory":"Game Over"}),(0,a.jsx)("p",{className:"text-[0.7rem] text-[color:var(--kali-text)] opacity-80",children:"victory"===N.runStatus?"All waves cleared. Review your run stats below.":"Lives depleted. Adjust your build or route and try again."}),(0,a.jsxs)("div",{className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/80 p-3 text-[0.65rem] text-[color:var(--kali-text)]",children:[(0,a.jsxs)("p",{children:["Waves cleared: ",N.stats.wavesCleared]}),(0,a.jsxs)("p",{children:["Enemies defeated: ",N.stats.enemiesDefeated]}),(0,a.jsxs)("p",{children:["Enemies leaked: ",N.stats.enemiesLeaked]}),(0,a.jsxs)("p",{children:["Time: ",(N.stats.elapsedMs/1e3).toFixed(1),"s"]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap justify-center gap-2 text-[0.7rem]",children:[(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-kali-control px-3 py-1 font-semibold text-black transition hover:brightness-110",onClick:H,children:"Restart"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-semibold text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{S.current.dispatch({type:"reset-run"}),S.current.dispatch({type:"set-editing",editing:!0}),P(!1),R(null),X()},children:"Return to Build"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-semibold text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{var e;return null==(e=_.current)?void 0:e.focus()},children:"Change Preset"})]})]})})]}),(0,a.jsx)("p",{className:"w-full max-w-[420px] text-center text-[0.65rem] text-[color:var(--kali-text)] opacity-80",children:ea}),N.routeError&&(0,a.jsx)("p",{className:"w-full max-w-[420px] rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/80 px-2 py-1 text-center text-[0.65rem] text-kali-severity-high",children:N.routeError}),(0,a.jsxs)("div",{className:"flex w-full max-w-[420px] flex-wrap items-center justify-center gap-2 text-xs sm:text-sm",children:[(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)] disabled:cursor-not-allowed disabled:opacity-40",onClick:()=>{S.current.dispatch({type:"set-editing",editing:!N.editing}),X()},disabled:"running"===N.runStatus||null!==N.countdown,children:N.editing?"Finish Editing":"Edit Route"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-kali-severity-high px-3 py-1 font-semibold text-white transition enabled:hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-40",onClick:H,disabled:!el||"running"===N.runStatus||null!==N.countdown,children:"Start Waves"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>P(e=>!e),children:T||L?"Resume":"Pause"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{S.current.dispatch({type:"reset-run"}),P(!1),R(null),X()},children:"Reset Run"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{let e=S.current.dispatch({type:"undo-path-cell"});!e.ok&&e.toast&&Y(e.toast),X()},disabled:!N.pathCells.length,children:"Undo Route"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{S.current.dispatch({type:"reset-run"}),S.current.dispatch({type:"clear-path-cells"}),S.current.dispatch({type:"set-editing",editing:!0}),P(!1),R(null),X()},children:"Clear Route"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{S.current.dispatch({type:"clear-towers"}),R(null),X()},children:"Clear Towers"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{var e;let t=JSON.stringify(N.waveConfig,null,2);B(t),null==(e=navigator.clipboard)||e.writeText(t).catch(()=>{}),Y("Wave JSON copied to clipboard.")},children:"Export Waves"}),(0,a.jsx)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel-highlight)] px-3 py-1 font-medium text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{try{let e=JSON.parse(G);Array.isArray(e)&&(S.current.dispatch({type:"set-wave-config",waves:e}),X())}catch(e){Y("Invalid wave JSON.")}},children:"Import Waves"})]})]}),(0,a.jsxs)("aside",{className:"w-full rounded-lg border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/90 p-3 text-[color:var(--kali-text)] shadow-kali-panel backdrop-blur lg:max-w-xs",children:[(0,a.jsx)("h2",{className:"text-sm font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-90",children:"Quick Play"}),(0,a.jsx)("p",{className:"mt-1 text-[0.7rem] text-[color:var(--kali-text)] opacity-80",children:"Pick a preset route and wave mix, then start immediately."}),(0,a.jsx)("label",{className:"mt-3 block text-[0.65rem] font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-70",htmlFor:"preset-select",children:"Preset"}),(0,a.jsx)("select",{id:"preset-select",ref:_,value:null==(e=v[U])?void 0:e.id,onChange:e=>{let t=v.findIndex(t=>t.id===e.target.value);t>=0&&J(t)},className:"mt-2 w-full rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)] px-2 py-2 text-xs text-[color:var(--kali-text)]",children:v.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("p",{className:"mt-2 text-[0.65rem] text-[color:var(--kali-text)] opacity-70",children:null==(t=v[U])?void 0:t.summary}),(0,a.jsx)("button",{type:"button",className:"mt-3 w-full rounded-md border border-[color:var(--kali-border)] bg-kali-control px-3 py-2 text-xs font-semibold uppercase tracking-wide text-black transition hover:brightness-110",onClick:()=>Q(U),children:"Apply Preset"}),(0,a.jsx)("h2",{className:"mt-5 text-sm font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-90",children:"Wave Designer"}),(0,a.jsx)("p",{className:"mt-1 text-[0.7rem] text-[color:var(--kali-text)] opacity-80",children:"Queue enemy types for each wave. Empty waves advance automatically, and spawn pacing is adjustable below."}),(0,a.jsx)("div",{className:"mt-3 max-h-56 space-y-2 overflow-y-auto pr-1",children:N.waveConfig.map((e,t)=>(0,a.jsxs)("div",{className:"rounded border border-[color:var(--kali-border)]/70 bg-[color:var(--kali-panel)]/70 p-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2 text-[0.7rem] font-medium uppercase tracking-wide text-[color:var(--kali-text)] opacity-80",children:[(0,a.jsxs)("span",{children:["Wave ",t+1]}),(0,a.jsx)("span",{className:"font-normal normal-case text-[color:var(--kali-text)] opacity-70",children:e.length?e.join(", "):"empty"})]}),(0,a.jsx)("div",{className:"mt-2 flex flex-wrap gap-1 text-[0.65rem]",children:Object.keys(s).map(e=>(0,a.jsxs)("button",{type:"button",className:"rounded border border-[color:var(--kali-border)]/60 bg-[color:var(--kali-panel-highlight)] px-2 py-1 font-semibold uppercase tracking-wide text-[color:var(--color-primary)] transition hover:bg-[color:color-mix(in_srgb,var(--color-primary)_25%,var(--kali-panel))]",onClick:()=>((e,t)=>{let r=N.waveConfig.map(e=>[...e]);r[e].push(t),S.current.dispatch({type:"set-wave-config",waves:r}),X()})(t,e),children:["+",e]},e))})]},t))}),(0,a.jsx)("button",{type:"button",className:"mt-3 w-full rounded-md border border-dashed border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/80 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-[color:var(--kali-text)] transition hover:bg-[color:var(--kali-panel)]",onClick:()=>{let e=[...N.waveConfig,[]];S.current.dispatch({type:"set-wave-config",waves:e}),X()},children:"Add Wave"}),(0,a.jsxs)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-70",htmlFor:"spawn-interval",children:["Spawn Interval (",N.spawnInterval.toFixed(1),"s)"]}),(0,a.jsx)("input",{id:"spawn-interval",type:"range",min:.4,max:1.8,step:.1,value:N.spawnInterval,onChange:e=>{S.current.dispatch({type:"set-spawn-interval",value:Number(e.target.value)}),X()},className:"mt-2 w-full accent-[color:var(--color-primary)]"}),(0,a.jsx)("label",{className:"mt-4 block text-xs font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-70",htmlFor:"wave-json-editor",children:"Wave JSON"}),(0,a.jsx)("textarea",{id:"wave-json-editor","aria-label":"Wave configuration JSON",className:"mt-2 h-28 w-full rounded-md border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/90 p-2 font-mono text-[0.65rem] text-[color:var(--kali-text)] focus:border-[color:var(--color-primary)] focus:outline-none",value:G,onChange:e=>B(e.target.value)}),ee&&(0,a.jsxs)("div",{className:"mt-4 rounded-lg border border-[color:var(--kali-border)] bg-[color:var(--kali-panel)]/80 p-3",children:[(0,a.jsx)("h3",{className:"text-xs font-semibold uppercase tracking-wide text-[color:var(--kali-text)] opacity-90",children:"Tower Upgrades"}),(0,a.jsxs)("div",{className:"mt-2 flex flex-col items-center gap-2",children:[(0,a.jsx)(c,{tower:ee}),(0,a.jsxs)("div",{className:"flex w-full flex-wrap justify-center gap-2 text-[0.65rem]",children:[(0,a.jsxs)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-kali-control px-3 py-1 font-medium text-black transition hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-40",onClick:()=>$("range"),disabled:N.gold<d(ee.level),children:["Increase Range (",d(ee.level),"g)"]}),(0,a.jsxs)("button",{type:"button",className:"rounded-md border border-[color:var(--kali-border)] bg-kali-control px-3 py-1 font-medium text-black transition hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-40",onClick:()=>$("damage"),disabled:N.gold<d(ee.level),children:["Increase Damage (",d(ee.level),"g)"]})]}),(0,a.jsxs)("p",{className:"text-[0.6rem] text-[color:var(--kali-text)] opacity-70",children:["Sell value: ",(e=>{let t=N.baseTowerCost;for(let r=1;r<e.level;r+=1)t+=d(r);return Math.max(1,Math.floor(.6*t))})(ee),"g (Right-click/Delete)"]})]})]})]})]}),!N.editing&&(0,a.jsx)(n,{towers:N.towers})]})})}},35539:(e,t,r)=>{r.d(t,{default:()=>l});var a=r(14232);function l(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=(0,a.useRef)(e);r.current=e,(0,a.useEffect)(()=>{let e;if(!t)return;let a=performance.now(),l=t=>{let o=(t-a)/1e3;a=t,r.current(o),e=requestAnimationFrame(l)};return e=requestAnimationFrame(l),()=>cancelAnimationFrame(e)},[t])}}}]);