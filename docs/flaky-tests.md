# Flaky test response playbook

This guide explains how we monitor, investigate, and retire flaky Playwright tests.

## 1. Monitoring signals

- **CI e2e job** – `.github/workflows/ci.yml` runs `yarn test:e2e` with retry logic. Artifacts include traces, the HTML report, and the weekly flaky summary generated by `playwright/utils/reporter.ts`.
- **Weekly summary** – the reporter emits `playwright-artifacts/flaky-summary-YYYY-Www.md` and a `quarantine-manifest.md`. These files are uploaded as workflow artifacts so the team can review them asynchronously.
- **Quarantine list** – `playwright/flaky-tests.ts` maintains the authoritative list of quarantined patterns. Each entry captures the reason and a tracking reference.

## 2. Quarantining a flaky test

1. Capture evidence from the CI artifacts (trace, video, console output).
2. Add or update an entry in `playwright/flaky-tests.ts` with:
   - A narrow regex matching the failing test title and optional file filter.
   - A `reason` that explains the failure mode.
   - A `ticket` pointing to an issue, doc entry, or tracking bug.
3. Re-run locally with `RUN_QUARANTINED=true yarn test:e2e` to confirm the test still fails and the annotation appears in the output.
4. Commit the updated config so CI skips the test while the fix is in flight.

## 3. Investigating and fixing flakes

- **Reproduce locally** – run `yarn dev` in one terminal and `RUN_QUARANTINED=true yarn test:e2e` in another. The environment variable forces quarantined tests to execute so you can iterate.
- **Check traces** – open the HTML report (`npx playwright show-report`) or download the CI artifact. Look for navigation errors, console noise, and network requests.
- **Stabilise timing** – prefer deterministic waits (e.g., `await expect(locator).toBeVisible()`) over `waitForTimeout`.
- **Audit external dependencies** – many flakes stem from rate limits or missing fixtures. Stub or mock external calls when possible.
- **Update regression coverage** – once the bug is fixed, delete the entry from `playwright/flaky-tests.ts` and run `yarn test:e2e` to ensure the suite is green without the quarantine.

## 4. Review cadence

- Review the uploaded weekly summary at the start of each week.
- Triaged entries should have an assignee and an ETA in the linked tracking ticket.
- Close the ticket once the quarantine entry is removed and the test passes two consecutive CI runs.
