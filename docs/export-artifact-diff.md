# Export artifact diff workflow

The export diff workflow captures the static export generated by `yarn export` for
both the pull request branch and its base. The new script `scripts/artifact-diff.mjs`
compares their `export-detail.json` schemas and the contents of the `.next/export`
directory, then publishes a Markdown summary and raw JSON report.

## What the CI job does

1. Build the PR branch with `yarn export` and store the results under
   `artifact-diff/head/`.
2. Check out the base commit in a temporary Git worktree, install dependencies,
   build its export, and store the results under `artifact-diff/base/`.
3. Run `node scripts/artifact-diff.mjs` to produce:
   - `artifact-diff/diff.json` – machine-readable data for further automation.
   - `artifact-diff/diff.md` – the Markdown summary posted on the PR.
4. Upload the whole `artifact-diff/` directory as a workflow artifact and comment
   on the PR with the Markdown summary.

The workflow lives in `.github/workflows/ci.yml` as the `export-diff` job.

## Running the diff locally

```bash
# Build the current branch export
rm -rf artifact-diff
yarn export
mkdir -p artifact-diff/head
cp -r .next/export artifact-diff/head/
cp .next/export-detail.json artifact-diff/head/export-detail.json

# Build the base branch in a worktree (example: origin/main)
git worktree add ../base-worktree origin/main
pushd ../base-worktree
yarn install --immutable --immutable-cache
yarn export
mkdir -p ../kali-linux-portfolio/artifact-diff/base
cp -r .next/export ../kali-linux-portfolio/artifact-diff/base/
cp .next/export-detail.json ../kali-linux-portfolio/artifact-diff/base/export-detail.json
popd
git worktree remove ../base-worktree

# Generate the comparison reports
node scripts/artifact-diff.mjs
```

The Markdown and JSON outputs are written to `artifact-diff/diff.md` and
`artifact-diff/diff.json` respectively.

## Customising the diff behaviour

The script accepts CLI flags and environment variables so maintainers can tune it
without editing the source:

| Flag | Environment variable | Description |
| ---- | -------------------- | ----------- |
| `--base-dir <path>` | `ARTIFACT_DIFF_BASE_DIR` | Location of the base export directory (default `artifact-diff/base/export`). |
| `--head-dir <path>` | `ARTIFACT_DIFF_HEAD_DIR` | Location of the head export directory (default `artifact-diff/head/export`). |
| `--base-schema <path>` | `ARTIFACT_DIFF_BASE_SCHEMA` | Path to the base branch `export-detail.json`. |
| `--head-schema <path>` | `ARTIFACT_DIFF_HEAD_SCHEMA` | Path to the PR branch `export-detail.json`. |
| `--output-json <path>` | `ARTIFACT_DIFF_OUTPUT_JSON` | Where to write the machine-readable report. |
| `--output-md <path>` | `ARTIFACT_DIFF_OUTPUT_MD` | Where to write the Markdown summary. |
| `--json-threshold <bytes>` | `ARTIFACT_DIFF_JSON_THRESHOLD` | Minimum byte delta before a JSON file gets a structural summary (default 2048 bytes). |

In the workflow you can override these values by setting the environment variables
before invoking the script. For example, to require a smaller JSON threshold:

```yaml
      - name: Compare exports
        env:
          ARTIFACT_DIFF_JSON_THRESHOLD: 1024
        run: |
          node scripts/artifact-diff.mjs
```

### Adjusting the PR comment

The `export-diff` job posts the Markdown summary on the PR. To disable the comment
or post it conditionally, edit the `Comment on PR` step at the end of the job. You
can reuse the generated `diff.md` for other notification channels as needed.

### Extending the report

The JSON output contains the raw schema differences, file size deltas, and the
summaries for large JSON changes. Downstream tooling can ingest
`artifact-diff/diff.json` to enforce thresholds (for example, failing the build if
certain files grow beyond a limit) without touching the script itself.
