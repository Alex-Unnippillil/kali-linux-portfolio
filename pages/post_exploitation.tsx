"use client";

import React, { useState } from 'react';
import Meta from '../components/SEO/Meta';
import modules, { ModuleMetadata } from '../modules/metadata';
import ModuleCard from '../components/ModuleCard';
import VirtualList from 'rc-virtual-list';
import EmptyState from '../components/system/EmptyState';

export default function PostExploitation() {
  const [query, setQuery] = useState('');
  const [selected, setSelected] = useState<ModuleMetadata | null>(null);
  const [selectedTags, setSelectedTags] = useState<string[]>([]);

  const actionButtonClass =
    'rounded-lg bg-[var(--color-accent)] px-4 py-2 text-sm font-semibold text-[var(--color-inverse)] transition-colors hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--color-surface)]';

  const resetFilters = () => {
    setQuery('');
    setSelectedTags([]);
    setSelected(null);
  };

  const transcript = `meterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\nmeterpreter > keyscan_start\nStarting the keystroke sniffer...\nmeterpreter > run persistence_service\n[*] Creating service accomplished\n`;

  const copyTranscript = () => {
    navigator.clipboard?.writeText(transcript);
  };

  const allTags = Array.from(new Set(modules.flatMap((m) => m.tags))).sort();

  const toggleTag = (tag: string) => {
    setSelectedTags((prev) =>
      prev.includes(tag) ? prev.filter((t) => t !== tag) : [...prev, tag]
    );
  };

  const filtered = modules.filter(
    (m) =>
      m.name.toLowerCase().includes(query.toLowerCase()) &&
      (selectedTags.length === 0 ||
        m.tags.some((t) => selectedTags.includes(t)))
  );

  const hasActiveFilters = query.trim().length > 0 || selectedTags.length > 0;

  return (
    <>
      <Meta />
      <main className="mx-auto grid gap-4 p-4 md:grid-cols-2">
        <section className="prose">
          <h1>Metasploit Post-Exploitation Modules</h1>
          <p>
            Post-exploitation refers to any actions taken after a session is opened. Rapid7&apos;s{' '}
            <a
              href="https://docs.rapid7.com/metasploit/about-post-exploitation/"
              target="_blank"
              rel="noopener noreferrer"
            >
              Metasploit documentation
            </a>{' '}
            explains that these modules run on an active session to help operators gather deeper
            information, escalate privileges, pivot within the network, or maintain persistence.
          </p>
          <input
            type="text"
            placeholder="Search modules..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            className="mb-4 w-full rounded border p-2"
          />
          <div className="mb-4 flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <label key={tag} className="flex items-center space-x-1">
                <input
                  type="checkbox"
                  checked={selectedTags.includes(tag)}
                  onChange={() => toggleTag(tag)}
                  className="rounded"
                />
                <span>{tag}</span>
              </label>
            ))}
          </div>
          {filtered.length === 0 ? (
            <div className="not-prose mt-6 flex justify-center">
              <EmptyState
                title="No modules found"
                helperText={
                  hasActiveFilters
                    ? 'Try adjusting your keywords or clear the filters to see every module.'
                    : 'There are no post-exploitation modules available right now.'
                }
                icon={
                  <svg
                    viewBox="0 0 24 24"
                    className="h-8 w-8"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="1.6"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  >
                    <circle cx="11" cy="11" r="6" />
                    <line x1="16.5" y1="16.5" x2="21" y2="21" />
                  </svg>
                }
                iconLabel="Magnifying glass"
                action={
                  hasActiveFilters ? (
                    <button type="button" onClick={resetFilters} className={actionButtonClass}>
                      Reset filters
                    </button>
                  ) : undefined
                }
              />
            </div>
          ) : (
            <VirtualList
              data={filtered}
              height={600}
              itemHeight={120}
              itemKey="name"
              component="ul"
              className="grid gap-4 list-none p-0"
            >
              {(m: ModuleMetadata) => (
                <li key={m.name}>
                  <ModuleCard
                    module={m}
                    onSelect={setSelected}
                    selected={selected?.name === m.name}
                    query={query}
                  />
                </li>
              )}
            </VirtualList>
          )}
        </section>
        <aside className="prose">
          {selected ? (
            <>
              <h2>{selected.name}</h2>
              <p>{selected.description}</p>
              <h3>Options</h3>
              <ul>
                {selected.options.map((opt) => (
                  <li key={opt.name}>
                    <strong>{opt.name}</strong>{' '}
                    {opt.required ? '(required)' : '(optional)'} - {opt.description}
                  </li>
                ))}
              </ul>
            </>
          ) : (
            <div className="not-prose mt-6 flex justify-center">
              <EmptyState
                className="max-w-sm px-6 py-8"
                title="Select a module"
                helperText="Choose an item from the list to inspect its description, options, and usage notes."
                icon={
                  <svg
                    viewBox="0 0 24 24"
                    className="h-8 w-8"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  >
                    <path d="M7 3h7l4 4v14a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z" />
                    <path d="M14 3v5h5" />
                    <path d="m9 14 2 2 4-4" />
                  </svg>
                }
                iconLabel="Document with check mark"
              />
            </div>
          )}
          <h3>Example Transcript</h3>
          <div className="flex items-start gap-2">
            <pre className="flex-1 overflow-x-auto rounded bg-black p-3 text-green-400 font-mono">
              {transcript}
            </pre>
            <button
              onClick={copyTranscript}
              className="px-2 py-1 text-sm rounded bg-gray-700"
            >
              Copy
            </button>
          </div>
        </aside>
      </main>
    </>
  );
}

